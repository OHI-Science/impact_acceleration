---
title: "CHI calculation"
output: html_document
---

This script summarizes all impacts to calculate Cumulative Human Impacts for each year.


## Loading packages

```{r setup, include=FALSE}

library(raster)
library(RColorBrewer)
library(sf)
library(dplyr)
library(stringr)
library(doParallel)
library(foreach)
library(parallel)

source("https://raw.githubusercontent.com/OHI-Science/ohiprep_v2018/master/src/R/spatial_common.R")

# parallel processing

registerDoSEQ()
registerDoParallel(4)

```

## Reading in data files
```{r}

# Years

years <- 2003:2013

years_subset <- paste(years, collapse="|")

```


## Calculation of CHI
This sums the impact rasters to calculate CHI.
```{r}

# select stressors with all years of data to include in model

stressors <- list.files(file.path(dir_M, "git-annex/impact_acceleration/impact/stressor_impact"))
stress_all <- str_sub(stressors, 1, str_length(stressors)-9)
stress_length <- table(stress_all)
stressors_all_yrs <- names(stress_length[stress_length == length(years)])

stressors_chi <- list.files(file.path(dir_M, "git-annex/impact_acceleration/impact/stressor_impact"),
                            full=TRUE)

stressors_chi <- grep(paste(stressors_full, collapse="|"), stressors_chi, value=TRUE)

length(stressors_chi)/length(years) # needs to be a whole number

foreach(year = years,.packages="dplyr") %dopar%{ # year=2013

  stressors_yr <- grep(year, stressors_chi, value=TRUE)
  
  stress_stack <- raster::stack(stressors_yr)
  
  raster::calc(stress_stack, fun=sum, na.rm=TRUE,
               filename=file.path(dir_M, sprintf("git-annex/impact_acceleration/tmp/summed_raster_%s.tif", year)), 
               overwrite=TRUE, progrss="text")
  
}


```

This checks to make sure that each year has the correct number of impacts.
```{r}

chi_check <- data.frame(year=years, length=c(NA))

for(year in years){ # year=2013
  stressors_yr <- grep(year, stressors_chi, value=TRUE)

  chi_check$length[tmp$year == year] <- length(stressors_yr)
 
}

## these should all have the same number and it should reflect the number of stressors
chi_check
```


Final formatting of raster, masking the ocean area.
```{r}

for(year in years) { # year=2013

  summed_rast <- raster::raster(file.path(dir_M, sprintf("git-annex/impact_acceleration/tmp/summed_raster_%s.tif", year)))

  raster::mask(summed_rast, ocean,
                  filename=file.path(dir_M, sprintf("git-annex/impact_acceleration/impact/cumulative_impact/chi_%s.tif", year)),
                  overwrite=TRUE)
  print(year)
}

